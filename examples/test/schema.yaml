# =============================================================================
# Alyx Schema Definition - Blog Template
# =============================================================================
# A complete blog schema with users, posts, and comments.
# Includes examples of relationships, validation, and access control.
# =============================================================================

version: 1

collections:
  # ---------------------------------------------------------------------------
  # Users - Blog authors and readers
  # ---------------------------------------------------------------------------
  users:
    fields:
      id:
        type: uuid
        primary: true
        default: auto
      email:
        type: string
        unique: true
        index: true
        validate:
          format: email
      name:
        type: string
        maxLength: 100
        nullable: true
      avatar_url:
        type: string
        nullable: true
      role:
        type: string
        default: "user"
        validate:
          enum: [user, author, admin]
      created_at:
        type: timestamp
        default: now
      updated_at:
        type: timestamp
        default: now
        onUpdate: now

    # Access rules:
    # - Anyone can register (create)
    # - Users can only read their own profile (or admins can read all)
    # - Users can only update their own profile
    # - Only admins can delete users
    rules:
      create: "true"
      read: "auth.id == doc.id || auth.role == 'admin'"
      update: "auth.id == doc.id"
      delete: "auth.role == 'admin'"

  # ---------------------------------------------------------------------------
  # Posts - Blog articles
  # ---------------------------------------------------------------------------
  posts:
    fields:
      id:
        type: uuid
        primary: true
        default: auto
      title:
        type: string
        minLength: 1
        maxLength: 200
      slug:
        type: string
        unique: true
        index: true
      content:
        type: text
      excerpt:
        type: string
        maxLength: 500
        nullable: true
      author_id:
        type: uuid
        references: users.id
        onDelete: cascade
        index: true
      published:
        type: bool
        default: false
      published_at:
        type: timestamp
        nullable: true
      tags:
        type: json
        nullable: true
      view_count:
        type: int
        default: 0
      created_at:
        type: timestamp
        default: now
      updated_at:
        type: timestamp
        default: now
        onUpdate: now

    # Composite indexes for common query patterns
    indexes:
      - name: idx_posts_published_date
        fields: [published, published_at]
        order: desc
      - name: idx_posts_author_date
        fields: [author_id, created_at]
        order: desc

    # Access rules:
    # - Only authenticated users can create posts
    # - Published posts are public; drafts only visible to author/admin
    # - Only author or admin can update/delete
    rules:
      create: "auth.id != null"
      read: "doc.published == true || auth.id == doc.author_id || auth.role == 'admin'"
      update: "auth.id == doc.author_id || auth.role == 'admin'"
      delete: "auth.id == doc.author_id || auth.role == 'admin'"

  # ---------------------------------------------------------------------------
  # Comments - User comments on posts
  # ---------------------------------------------------------------------------
  comments:
    fields:
      id:
        type: uuid
        primary: true
        default: auto
      post_id:
        type: uuid
        references: posts.id
        onDelete: cascade
        index: true
      author_id:
        type: uuid
        references: users.id
        onDelete: cascade
      content:
        type: text
        maxLength: 5000
      created_at:
        type: timestamp
        default: now

    # Access rules:
    # - Only authenticated users can comment
    # - All comments are public
    # - Only the author can edit their comment
    # - Author or admin can delete
    rules:
      create: "auth.id != null"
      read: "true"
      update: "auth.id == doc.author_id"
      delete: "auth.id == doc.author_id || auth.role == 'admin'"

# =============================================================================
# Additional Collections You Might Add
# =============================================================================
# 
# categories:
#   fields:
#     id: { type: uuid, primary: true, default: auto }
#     name: { type: string, maxLength: 50 }
#     slug: { type: string, unique: true, index: true }
#     description: { type: text, nullable: true }
#   rules:
#     create: "auth.role == 'admin'"
#     read: "true"
#     update: "auth.role == 'admin'"
#     delete: "auth.role == 'admin'"
#
# tags:
#   fields:
#     id: { type: uuid, primary: true, default: auto }
#     name: { type: string, unique: true, maxLength: 30 }
#   rules:
#     create: "auth.id != null"
#     read: "true"
#     update: "auth.role == 'admin'"
#     delete: "auth.role == 'admin'"
#
# media:
#   fields:
#     id: { type: uuid, primary: true, default: auto }
#     filename: { type: string }
#     url: { type: string }
#     mime_type: { type: string }
#     size: { type: int }
#     uploaded_by: { type: uuid, references: users.id, onDelete: cascade }
#     created_at: { type: timestamp, default: now }
#   rules:
#     create: "auth.id != null"
#     read: "true"
#     update: "auth.id == doc.uploaded_by || auth.role == 'admin'"
#     delete: "auth.id == doc.uploaded_by || auth.role == 'admin'"
